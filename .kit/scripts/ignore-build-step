#!/bin/bash

DEBUG=${DEBUG:-0}

previous_release_rev="$VERCEL_GIT_PREVIOUS_SHA"
current_tag_rev=$(git describe --tags --abbrev=0 --contains --match "$1" 2>/dev/null)
previous_tag_rev=$(git describe --tags --abbrev=0 ${current_tag_rev:+"--exclude" "$current_tag_rev"} --match "$1" 2>/dev/null)
previous_tag_child_rev=$(git rev-list --reverse --ancestry-path "$previous_tag_rev..HEAD" 2>/dev/null | head -n 1)
previous_commit_rev='HEAD^'

since_previous_commit=$(git diff --quiet HEAD "$previous_commit_rev" "$2" 2>/dev/null ; echo $?)
since_previous_release=$(git diff --quiet HEAD "$previous_release_rev^" "$2" 2>/dev/null ; echo $?)
since_previous_tag=$(git diff --quiet HEAD "$previous_tag_child_rev" "$2" 2>/dev/null ; echo $?)

if [ $DEBUG = "1" ]; then
  echo "current_tag_rev:"
  echo "  command: git describe --tags --abbrev=0 --contains --match \"$1\" 2>/dev/null"
  echo "  result: $current_tag_rev"
  echo ""

  echo "previous_tag_rev:"
  echo "  command: git describe --tags --abbrev=0 ${current_tag_rev:+"--exclude" "$current_tag_rev"} --match \"$1\" 2>/dev/null"
  echo "  result: $previous_tag_rev"
  echo ""

  echo "previous_tag_child_rev:"
  echo "  command: git rev-list --reverse --ancestry-path \"$previous_tag_rev..HEAD\" 2>/dev/null | head -n 1"
  echo "  result: $previous_tag_child_rev"
  echo ""

  echo "result:"
  echo "  command: git diff --quiet HEAD \"$previous_commit_rev\" \"$2\" 2>/dev/null ; echo \$?"
  echo "  since_previous_commit: $since_previous_commit"
  echo "  command: git diff --quiet HEAD \"$previous_release_rev^\" \"$2\" 2>/dev/null ; echo \$?"
  echo "  since_previous_release: $since_previous_release"
  echo "  command: git diff --quiet HEAD \"$previous_tag_child_rev\" \"$2\" 2>/dev/null ; echo \$?"
  echo "  since_previous_tag: $since_previous_tag"
  echo ""
fi

# The diff command fails when there are more than 10 commits since the previous release,
# in that case we always trigger a deployment
if [ "$since_previous_commit" = "0" ] && [ "$since_previous_release" = "0" ] && [ "$since_previous_tag" = "0" ]; then
  echo "ðŸ›‘ - Build cancelled"
  exit 0
else
  echo "âœ… - Build can proceed"
  exit 1
fi
